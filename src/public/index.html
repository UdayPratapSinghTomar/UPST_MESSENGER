<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chat App Test</title>
  <style>
    #chat {
      border: 1px solid #ccc;
      height: 300px;
      overflow-y: auto;
      padding: 10px;
    }
    .msg {
      margin-bottom: 6px;
    }
  </style>
</head>
<body>

<h2>Chat Test</h2>

<input id="token" placeholder="Access Token" style="width:100%" />
<br><br>

<input id="chatId" type="number" placeholder="Chat ID" value="1" />

<br><br>

<button onclick="connectSocket()">Connect Socket</button>
<button onclick="joinChat()">Join Chat</button>

<hr>

<div id="chat"></div>

<input id="message" placeholder="Message..." />
<button onclick="sendMessage()">Send</button>

<script src="/socket.io/socket.io.js"></script>

<script>
  let socket;

  const chatBox = document.getElementById("chat");

  function connectSocket() {
    const token = document.getElementById("token").value;
    if (!token) return alert("Token required");

    socket = io("http://43.205.214.125:3000", {
      auth: { token }
    });

    socket.on("connect", () => {
      console.log("‚úÖ Socket connected", socket.id);
    });

    socket.on("connected", (data) => {
      console.log("üîê Auth OK", data);
    });

    socket.on("joined_chat", (data) => {
      console.log("üìå Joined chat", data.chat_id);
    });

    socket.on("new_message", (msg) => {
      addMessage(msg);
    });

    socket.on("socket_error", (err) => {
      console.error("‚ùå Socket error", err);
    });
  }

  function joinChat() {
    const chatId = Number(document.getElementById("chatId").value);
    socket.emit("join_Chat", chatId);
  }

  function addMessage(msg) {
    const div = document.createElement("div");
    div.className = "msg";
    div.innerText = `User ${msg.sender_id}: ${msg.content}`;
    chatBox.appendChild(div);
  }

  async function sendMessage() {
    const token = document.getElementById("token").value;
    const chatId = Number(document.getElementById("chatId").value);
    const content = document.getElementById("message").value;

    if (!content) return;

    await fetch("http://43.205.214.125:3000/message/send", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + token,
      },
      body: JSON.stringify({ chat_id: chatId, content }),
    });

    document.getElementById("message").value = "";
  }
</script>

</body>
</html>
